<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Implementation of the workers - mini_ci</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><a href="constraints.html">Constraints of the project</a></li><li class="chapter-item expanded affix "><a href="architecture.html">Architecture</a></li><li class="chapter-item expanded affix "><a href="implementation_of_the_web_server.html">Implementation of the web server</a></li><li class="chapter-item expanded affix "><a href="implementation_of_the_workers.html" class="active">Implementation of the workers</a></li><li class="chapter-item expanded affix "><a href="security.html">Self security assessment</a></li><li class="chapter-item expanded affix "><a href="performance_assessment.html">Performance self assessment</a></li><li class="chapter-item expanded affix "><a href="future_work.html">Future work</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">mini_ci</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="implementation-of-the-workers"><a class="header" href="#implementation-of-the-workers">Implementation of the workers</a></h1>
<h2 id="language-choice"><a class="header" href="#language-choice">Language choice</a></h2>
<p>There are no technical reasons to force the same technologies on the web server side as in the workers, however
<code>rust</code> fits the constraints of both, therefore there is also no reason to use two different programming
languages here either. For simplicity reason, <code>rust</code> stayed.</p>
<h2 id="picking-up-a-task"><a class="header" href="#picking-up-a-task">Picking up a task</a></h2>
<p>The tasks a worker can execute depend on the configuration of the machine itself. For example, if a static
analyser isn't installed on one machine, the worker executing on that machine can't obvioulsy perform the
task of running the static analyser on the developer's code.</p>
<p>Therefore before assigning a task to a worker, it is necessary to know what the worker can and cannot do. For
simplicity reason, the choice was made to have the worker poll for pending tasks. It is therefore up to the
worker to tell what it can do when looking a task. This capability should be configured per-worker since it
ultimately depends on the configuration of the machine. The configuration is for now hard-coded in the
code. Changing the configuration requires therefore to change the code and recompile. Certainly not pretty,
but good enough for my needs of the moment.</p>
<h2 id="executing-a-task"><a class="header" href="#executing-a-task">Executing a task</a></h2>
<p>The workers are really simple, do not implement any security feature, and rely on hard-coded knowledge from
the project codebase it executes things on. For example, to execute a task, a worker will:</p>
<ol>
<li>retrieve the commit hash and the task to perform from the database</li>
<li><code>git clone</code> that commit</li>
<li>either:
<ul>
<li>run a script from the cloned folder for tasks such as <code>formatting code</code> or <code>static analysis</code>.</li>
<li>call <code>cmake generate &lt;some parameters&gt; &amp;&amp; cmake build &amp;&amp; ctest</code> in the project folder</li>
</ul>
</li>
</ol>
<p>This keeps the worker's code simple however it brings two notable issues:</p>
<ul>
<li>huge security issue of type remote code execution (more on that on the <a href="./security.html">Self security assessment page</a>)</li>
<li>no backforward/forward compatibility</li>
</ul>
<p><em>Backward/forward compatibility issue</em> means that since the knowledge to execute a task is hardcoded
to run a script, the day the file name of those scripts changes, or take different arguments, the CI
will need to be adapted.</p>
<h2 id="reporting-tasks-that-will-be-executed"><a class="header" href="#reporting-tasks-that-will-be-executed">Reporting tasks that will be executed</a></h2>
<p>When running tests, the worker finds itself the exact list of test to run by running <code>ctest --show-only=human</code>
and potentially filtering out tests the user asked not to execute. It then reports the exact list
into the database. This is how it is possible for the webserver to list the tests that gets executed.</p>
<h2 id="tests-execution"><a class="header" href="#tests-execution">Tests execution</a></h2>
<p>Tests are executed sequentially even more than one hardware resource is available. This is obviously
suboptimal and the only reason it is that way is because I didn't spend time implementing this feature.</p>
<h2 id="reporting-data-constantly-to-the-database"><a class="header" href="#reporting-data-constantly-to-the-database">Reporting data constantly to the database</a></h2>
<p>When executing a task, the worker will execute long-running commands in the background, keep reading the
standard output and standard error produced by said commands and constantly update the database with it.</p>
<p>At the moment, only long running commands are executed that way. A few commands are still executed
synchronously and the worker wait for them to finish before reporting their output. Those are:</p>
<ul>
<li><code>git clone</code></li>
<li><code>git remote update</code></li>
<li><code>cmake generate stage</code></li>
</ul>
<p>These commands execute under two seconds. The user experience is therefore not too negatively affected.
The only reason why these commands are executed that way is only due to lack of time to turn them to
background commands after an initial implementation.</p>
<p>Since the database is not available through the network, any access to it is done through special routes
provided by the webserver.</p>
<p>In order to avoid excessive network I/O, the worker will try to batch outputs, such that several lines of
<code>stdout/stderr</code> can be appended in the database with only one network request.</p>
<p>Importantly, the worker sanitises what it reads on <code>stdout/stderr</code> such that what is saved in the database
is guaranteed to be valid <code>utf-8</code>, meaning the inputs might be slightly silently modified in the process.</p>
<h2 id="taking-a-worker-out"><a class="header" href="#taking-a-worker-out">Taking a worker out</a></h2>
<p>When a developer needs to troubleshoot some issue, it is common that he will need an exclusive access to the
hardware. Since a worker is consistently looking for picking up a task to execute and run command on the same
hardware, there is a contention situation. To resolve this, there must be a way to tell a worker to
temporarily stop picking up new tasks.</p>
<p>This feature is implemented through <code>unix signals</code>. When a developer needs to shut off a worker so he can have
full control of the machine, he will send a signal <code>SIGINT</code> or <code>SIGTERM</code> to the worker. Upon receiving it, the
worker will acknowledge it by writing a message on the console, and finish its current task before exiting.
Sending a second signal will order the worker to abort its ongoing task to immediately relinquish resources.</p>
<p>A worker can then later be restarted normally.</p>
<h2 id="missing-feature-from-the-worker"><a class="header" href="#missing-feature-from-the-worker">Missing feature from the worker</a></h2>
<p>Besides the lack of parallelism when running tests, one other missing feature here is that the only output the
worker reports in the database is what the executed commands produce on their <code>stdout/stderr</code>. Any other
artifiacts, such as files produced on the file system, are simply discarded at the end of a task
execution. Again, this was good enough for my needs.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="implementation_of_the_web_server.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="security.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="implementation_of_the_web_server.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="security.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
